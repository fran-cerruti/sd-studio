# SD-Studio

A lightweight, optimized Stable Diffusion web interface with ControlNet support. Built for efficiency on consumer GPUs.

## Features

- **Simple Generation**: Text-to-image with customizable parameters
- **Batch Processing**: Generate multiple variations automatically
- **ControlNet**: Image-guided generation with Canny edge detection
- **Gallery**: Browse, search, and manage generated images
- **GPU Monitoring**: Real-time VRAM, utilization, and temperature stats
- **Network Access**: Use from any device on your local network

## Requirements

- **Python**: 3.10 or higher
- **GPU**: NVIDIA GPU with CUDA support (tested on GTX 1060 3GB+)
- **VRAM**: Minimum 3GB (4GB+ recommended)
- **OS**: Linux (Ubuntu/Debian tested), Windows with WSL2

## Quick Start

### 1. Clone Repository

```bash
git clone <repository-url>
cd sd-studio
```

### 2. Create Virtual Environment

```bash
python3 -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
```

### 3. Install Base Dependencies

```bash
pip install torch pynvml
```

### 4. Run Hardware Setup (Recommended)

**This script will detect your GPU and optimize the configuration automatically:**

```bash
python setup.py
```

The setup script will:
- Detect your GPU model, VRAM, and architecture
- Recommend optimal settings for your hardware
- Configure memory optimizations (attention slicing, VAE slicing, CPU offload)
- Install additional dependencies if compatible (e.g., xformers for Volta+ GPUs)
- Create backups before making any changes

**Example output:**
```
GPU: NVIDIA GeForce GTX 1060 3GB
VRAM: 3.0 GB
Architecture: Pascal (SM 6.1)

Profile: LOW_VRAM
Optimizations:
  • Attention Slicing: ✓ Activated
  • VAE Slicing: ✓ Activated
  • CPU Offload: ✓ Activated

⚠ xformers NOT compatible with Pascal (requires Volta+)
  → Your GPU will work correctly without xformers
```

### 5. Install Remaining Dependencies

```bash
pip install -r requirements.txt
```

**Note:** If you skip step 4, the default configuration is optimized for low-VRAM GPUs (3-4GB).

### 6. Download Models

Create a `models/` directory and download Stable Diffusion models:

```bash
mkdir -p models
```

**Recommended models:**
- [Stable Diffusion 1.5](https://huggingface.co/runwayml/stable-diffusion-v1-5)
- [Realistic Vision](https://huggingface.co/SG161222/Realistic_Vision_V5.1_noVAE)
- Any `.safetensors` model compatible with Stable Diffusion 1.5

Place `.safetensors` files in the `models/` directory.

### 5. Start Server

```bash
python generation_api_v2.py
```

The server will start on `http://localhost:8080`

### 6. Access Interface

- **Local**: Open browser to `http://localhost:8080`
- **Network**: From other devices, use `http://YOUR_IP:8080`

## Configuration

### Hardware Profiles

SD-Studio automatically configures itself based on your GPU:

| Profile | VRAM | GPUs | Optimizations |
|---------|------|------|---------------|
| **LOW_VRAM** | < 4GB | GTX 1050 Ti, GTX 1060 3GB | Attention slicing, VAE slicing, CPU offload |
| **MEDIUM_VRAM** | 4-6GB | GTX 1060 6GB, GTX 1650, RTX 2060 | VAE slicing, xformers (if compatible) |
| **HIGH_VRAM** | > 6GB | RTX 3060+, RTX 4060+ | Minimal optimizations, xformers |

**To reconfigure:** Run `python setup.py` again if you upgrade your GPU.

**Manual override:** Edit `config.py` directly if you need custom settings.

### GPU Architecture Compatibility

- **Pascal (GTX 10xx)**: ✅ Fully supported, xformers not available
- **Turing (GTX 16xx, RTX 20xx)**: ✅ Fully supported, xformers available
- **Ampere (RTX 30xx)**: ✅ Fully supported, xformers available
- **Ada Lovelace (RTX 40xx)**: ✅ Fully supported, xformers available

### Firewall (Linux)

To access from other devices on your network:

```bash
sudo ufw allow 8080/tcp
```

### Finding Your IP

```bash
ip addr show | grep "inet 192"
```

## Usage

### Generate Tab

1. Select or load a model
2. Enter your prompt
3. Adjust parameters (resolution, steps, CFG scale)
4. Click "Generate"

### Batch Tab

1. Add multiple prompts
2. Configure variations (CFG, steps, resolutions)
3. Generate all combinations automatically

### ControlNet Tab

1. Upload or select an image from gallery
2. Adjust Canny edge detection parameters
3. Preview edges
4. Generate with prompt guidance

### Gallery Tab

1. Browse all generated images
2. Search by filename
3. Sort by date or name
4. View fullscreen and navigate
5. Delete unwanted images

## Project Structure

```
sd-studio/
├── setup.py                 # Hardware detection and configuration
├── config_templates.py      # Configuration templates
├── generation_api_v2.py     # Main API server
├── config.py                # Configuration (auto-generated by setup.py)
├── model_manager.py         # Model loading and management
├── batch_processor.py       # Batch generation engine
├── controlnet_manager.py    # ControlNet integration
├── frontend/                # Web interface
│   ├── index.html
│   ├── app.js
│   └── favicon.ico
├── models/                  # Place .safetensors models here
├── outputs/                 # Generated images
├── requirements.txt         # Python dependencies
└── .setup_backup/           # Automatic backups (created by setup.py)
```

## API Endpoints

- `GET /` - Web interface
- `POST /generate` - Simple generation
- `POST /batch/generate` - Batch generation
- `POST /controlnet/generate` - ControlNet generation
- `GET /gallery` - List generated images
- `GET /gpu-info` - GPU statistics
- `GET /models` - List available models
- `POST /load-model` - Load a model

Full API documentation available at `http://localhost:8080/docs`

## Troubleshooting

### Out of Memory

- Reduce image resolution (512x512 or lower)
- Reduce number of inference steps
- Close other GPU applications
- Use models optimized for low VRAM

### Slow Generation

- Ensure CUDA is properly installed
- Check GPU utilization in header stats
- Consider enabling xformers (uncomment in requirements.txt)

### Model Not Loading

- Verify model file is in `models/` directory
- Check file format is `.safetensors`
- Ensure model is compatible with Stable Diffusion 1.5

### Network Access Issues

- Verify firewall allows port 8080
- Check devices are on same network
- Use IP address, not hostname

## License

Private project. All rights reserved.

## Credits

Built with:
- [Diffusers](https://github.com/huggingface/diffusers) by Hugging Face
- [ControlNet](https://github.com/lllyasviel/ControlNet)
- [FastAPI](https://fastapi.tiangolo.com/)
- [Vue.js](https://vuejs.org/)
